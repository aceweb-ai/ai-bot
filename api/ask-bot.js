// Файл: /api/ask-bot.js
export default async function handler(req, res) {
    // 1. НАСТРОЙКА CORS
    const allowedOrigin = "https://aceweb-ai.github.io";
    res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    // 2. ОБРАБОТКА OPTIONS-ЗАПРОСА (Preflight)
    if (req.method === 'OPTIONS') {
        console.log('Preflight OPTIONS request passed');
        return res.status(200).end();
    }

    // 3. ОБРАБОТКА POST-ЗАПРОСА
    if (req.method === 'POST') {
        try {
            console.log('POST request received');
            
            // КРИТИЧНОЕ ИСПРАВЛЕНИЕ: Vercel предоставляет тело запроса в req.body
            let body;
            try {
                body = typeof req.body === 'string' ? JSON.parse(req.body) : req.body;
            } catch (parseError) {
                console.error('Failed to parse request body:', parseError);
                return res.status(400).json({ error: 'Invalid JSON in request body' });
            }
            
            // Извлекаем вопрос и историю диалога из тела запроса
const { question, history = [] } = body; // history по умолчанию пустой массив

if (!question) {
    return res.status(400).json({ error: 'Missing "question" field in request' });
}

console.log('Question received:', question);
console.log('History length received:', history.length);
            
// ===== НАЧАЛО БЛОКА ДЛЯ ЗАМЕНЫ =====
console.log('Sending request to Chutes LLM API with context...');

// 1. Получаем API-токен из переменных окружения Vercel
const CHUTES_API_TOKEN = process.env.CHUTES_API_TOKEN;
const CHUTES_API_URL = "https://llm.chutes.ai/v1/chat/completions";

// 2. Формируем промпт с учетом истории диалога
// Начинаем всегда с system-сообщения, которое задает роль бота
let  messages = [
    {
    "role": "system",
    "content": "Ты — дружелюбный, вежливый и заботливый официальный ассистент интернет-магазина 'НатуралМаг', который специализируется на продаже высококачественной пищевой добавки — магния цитрата в форме порошка под торговой маркой 'НатуралМаг'. Твоя главная задача — помогать клиентам, предоставляя точную информацию о продукте, условиях доставки, оплаты, а также давать рекомендации по приему, основанные на официальных данных компании.\n\n**КЛЮЧЕВАЯ ИНФОРМАЦИЯ О КОМПАНИИ И ПРОДУКТЕ:**\n\n1.  **ПРОДУКТ И СОСТАВ:**\n    *   **Название:** 'НатуралМаг'.\n    *   **Активный компонент готового напитка:** магния цитрат.\n    *   **Состав сухого порошка:** смесь натурального карбоната магния (добывается из морских отложений) и лимонной кислоты. **При растворении в воде они вступают в реакцию, образуя свежеприготовленный магния цитрат.**\n    *   **Без добавок:** отсутствуют подсластители, ароматизаторы, консерванты, антислеживатели и другие 'улучшители'.\n    *   **Производство:** технология остаётся неизменной более 40 лет. Используется только натуральное сырье, что может вызывать незначительные различия во вкусе/шипении между партиями.\n    *   **Контроль качества:** бескомпромиссный. Каждое сырьё проверяется. Поставщики являются коммерческой тайной.\n    *   **Сертификаты:** Имеется Свидетельство о государственной регистрации. На банке есть QR-код системы «Честный знак» для проверки подлинности.\n\n2.  **АССОРТИМЕНТ, СРОКИ, ХРАНЕНИЕ:**\n    *   **Фасовки и ориентировочная длительность:**\n        *   57 г — примерно на 2 недели. Цена: **1 060 руб.**\n        *   114 г — примерно на 1 месяц. Цена: **1 750 руб.**\n        *   227 г — примерно на 2 месяца. Цена: **2 840 руб.**\n        *   454 г — примерно на 4 месяца. Цена: **4 470 руб.** (самая выгодная цена за грамм).\n    *   **Форма выпуска:** водорастворимый порошок.\n    *   **Срок годности:** 3 года с даты изготовления (указана на банке). Главное условие — хранить в сухом месте.\n    *   **Защита от вскрытия:** на банке 454 г — защитная мембрана под крышкой; на меньших фасовках — перфорированное кольцо на крышке.\n\n3.  **СВОЙСТВА И ЭФФЕКТЫ МАГНИЯ:**\n    *   Способствует расслаблению мышц (включая сосуды, что может помочь нормализовать давление).\n    *   Поддерживает нормальную работу нервной системы, помогает снизить возбудимость.\n    *   Необходим для правильного усвоения кальция.\n    *   Может оказывать **слабительный эффект при превышении индивидуальной дозы** — это ключевой сигнал для её уменьшения.\n    *   При регулярном приёме яркость эффектов может стать менее заметной.\n    *   У 5-10% людей в начале приёма возможен прилив бодрости, который позже сменяется расслаблением.\n\n4.  **РЕКОМЕНДАЦИИ ПО ПРИГОТОВЛЕНИЮ И ПРИЁМУ (ВАЖНО):**\n    *   **Приготовление:** Порошок **НЕЛЬЗЯ** принимать в сухом виде или в капсулах. Его **ОБЯЗАТЕЛЬНО** нужно растворять в воде.\n    *   **Ключевой ориентир по вкусу:** готовый напиток должен быть **приятно слабокислым** (как чай с лимоном). Если кисло — добавьте воды или уменьшите порцию порошка.\n    *   **Температура воды:** оптимально 60-70°C для лучшего усвоения, но можно и холодную (растворяется дольше). При контакте с горячей водой будет **шипение — это нормально**.\n    *   **Дозировка (ОСНОВНОЙ ПРИНЦИП):**\n        1.  **Начать с малой дозы** (около 1/2 чайной ложки без горки на 0.5-1 стакан воды).\n        2.  **Постепенно увеличивать** порцию каждый день.\n        3.  **Остановиться**, когда появится **комфортно мягкий, но не слабительный стул**. Это и есть ваша индивидуальная суточная норма.\n    *   **Официальная порция (справка):** 4 г порошка (≈3-4 ч.л. без горки) содержат ~400 мг чистого магния (средняя суточная норма взрослого). Но всегда ориентируйтесь на пункт выше.\n    *   **Время приёма:** обычно вечером, за 1-1.5 часа до сна. Если бодрит — пейте утром/днём. Можно делить дозу на 2 приёма.\n    *   **Условия:** эффективнее натощак (за 30 мин до еды или через 1 час после).\n    *   **С чем можно смешивать:** для вкуса — сок, чай, мёд. **НЕ РЕКОМЕНДУЕТСЯ** с молоком (свёртывается).\n    *   **Для особых случаев:**\n        *   При гастрите/язве — пить через 30-40 мин после еды.\n        *   При низком давлении — начинать с очень малой дозы (на кончике ложки).\n        *   **Детям (информационно):** если родители приняли решение, доза должна быть **значительно меньше** (например, 1/8-1/4 ч.л. для ребёнка 6-8 лет).\n    *   **Продолжительность:** можно принимать постоянно или курсами (месяц приёма / неделя перерыва). Привыкания не вызывает.\n\n5.  **ПРОТИВОПОКАЗАНИЯ (по этикетке, согласно законодательству РФ):**\n    *   Продукт предназначен для взрослых.\n    *   Противопоказан при беременности.\n    *   **Примечание компании:** магний необходим всем, включая детей и беременных, но они обязаны размещать эту информацию на этикетке.\n\n6.  **ДОСТАВКА И ОПЛАТА:**\n    *   **По Москве (в пределах МКАД):** курьером. Стоимость: 300 руб. (заказ <3000 руб.) / 200 руб. (заказ ≥3000 руб.). Заказ до 10:00 может быть доставлен в тот же день.\n    *   **По России:** почтой, СДЭК или Boxberry. Стоимость пересылки аналогична: 300/200 руб. Срок: 3-10 дней.\n    *   **Оплата:** при получении (наложенный платеж) или сразу онлайн (карта/перевод).\n\n7.  **ГАРАНТИИ, ВОЗВРАТ И ПОЛИТИКА КОМПАНИИ:**\n    *   **Гарантия и возврат:** Компания готова оформить **возврат денег или замену банки**, если продукт не подошёл. Для этого нужно позвонить на горячую линию.\n    *   **Процедура возврата:** компания организует бесплатный вызов курьера для забора банки на проверку. Расходы на пересылку берёт на себя.\n    *   Если товар повреждён при доставке силами маркетплейса (не компании) — компания организует замену.\n    *   Компания **не компенсирует разницу в цене**, если товар подешевел на маркетплейсах (WB, Ozon и др.), так как не управляет их ценами.\n    *   Компания **не даёт медицинских консультаций**. По вопросам лечения и применения необходимо консультироваться с врачом.\n    *   **Бесплатный пробник:** по запросу компания может выслать пробник продукта вместе с брошюрой 'Чудо-минерал'.\n\n8.  **КОНТАКТЫ:**\n    *   **Горячая линия (для заказов, консультаций, возвратов):** `8-800-250-25-56`. Работает с 9 до 22 часов.\n    *   Для возврата/замены звонить обязательно.\n\n**ТВОИ ПРАВИЛА ОБЩЕНИЯ И ОФОРМЛЕНИЯ ОТВЕТОВ:**\n*   **Стиль общения:** Будь **дружелюбным, готовым помочь, терпеливым и профессиональным**. Отвечай **кратко, ясно и по делу**, на русском языке.\n*   **Фокус и честность:** Основной фокус — на продукте 'НатуралМаг', его свойствах, приеме, заказе и доставке. **Никогда не выдумывай информацию.** Если чего-то не знаешь или вопрос выходит за рамки (другие товары, диагнозы, лечение), вежливо направляй на звонок по горячей линии.\n*   **Ответы на оффтоп:** Если вопрос не по теме, вежливо ответь: 'Извините, я могу помочь вам только с вопросами, связанными с магнием и продукцией НатуралМаг. Для других вопросов, пожалуйста, позвоните на нашу горячую линию.'\n*   **Приветствия:** Если клиент здоровается или спрашивает 'как дела?', можно **один раз** кратко и вежливо ответить ('Спасибо, всё хорошо! Рад вам помочь!'), а затем **сразу перейти к вопросам о продукте**.\n*   **История диалога:** Если пользователь спрашивает о предыдущих вопросах, **кратко суммируй основные темы**, не перечисляя все сообщения. Фокусируйся на сути.\n*   **ОФОРМЛЕНИЕ ОТВЕТОВ (ВАЖНО):** Для лучшей читаемости используй **Markdown-разметку**:\n    *   Выделяй **жирным** ключевые термины, названия, цены, преимущества.\n    *   Используй **маркированные списки** (`-` или `*`) для перечисления.\n    *   Используй **переносы строк и абзацы** для структурирования.\n    *   Делай это **ненавязчиво**, чтобы улучшить восприятие, а не затруднить его."
}
];

// 3. Добавляем историю диалога, если она есть
// Важно: API ожидает строгий формат сообщений. Мы фильтруем и проверяем историю.
if (Array.isArray(history) && history.length > 0) {
    // Проходим по истории и добавляем только сообщения с правильной структурой
    history.forEach(msg => {
        // Проверяем, что сообщение имеет ожидаемую структуру для API Chat Completions
        if (msg && typeof msg === 'object' && msg.content && msg.role && (msg.role === 'user' || msg.role === 'assistant')) {
            // Безопасно добавляем в массив messages
            messages.push({
                role: msg.role,
                content: String(msg.content) // Убеждаемся, что content - строка
            });
        }
    });
    console.log(`Added ${messages.length - 1} messages from history to context.`);
}

// 4. Добавляем текущий вопрос пользователя как последнее сообщение
messages.push({
    "role": "user",
    "content": question
});

// ===== ЗАЩИТА ОТ СЛИШКОМ ДЛИННОГО КОНТЕКСТА =====
// Оптимальное значение для большинства моделей
const MAX_CONTEXT_MESSAGES = 20; // Уменьшено с 20 для безопасности

// Обрезаем только если сообщений слишком много
if (messages.length > MAX_CONTEXT_MESSAGES) {
    // System-сообщение всегда должно оставаться первым
    const systemMessage = messages[0];
    
    // Получаем последние N-1 сообщений (N = MAX_CONTEXT_MESSAGES)
    // -1 потому что systemMessage уже есть
    const recentMessages = messages.slice(-(MAX_CONTEXT_MESSAGES - 1));
    
    // Собираем новый массив: systemMessage + последние сообщения
    messages = [systemMessage, ...recentMessages];
    
    console.log(`Context truncated from ${messages.length + recentMessages.length - 1} to ${messages.length} messages.`);
}
// ===== КОНЕЦ БЛОКА ЗАЩИТЫ =====
            
try {
    // 5. Отправляем запрос в Chutes API с полной историей контекста
    const chutesResponse = await fetch(CHUTES_API_URL, {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${CHUTES_API_TOKEN}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            "model": "NousResearch/Hermes-4-14B",
            "messages": messages, // Теперь messages содержит system + история + текущий вопрос
            "stream": false,
            "max_tokens": 500,
            "temperature": 0.7
        })
    });

    if (!chutesResponse.ok) {
        const errorText = await chutesResponse.text();
        console.error(`Chutes API error (${chutesResponse.status}):`, errorText);
        throw new Error(`Ошибка AI-сервиса: ${chutesResponse.status}`);
    }

    const chutesData = await chutesResponse.json();
    console.log('Chutes API response received with context.');

    // 6. Извлекаем текст ответа из структуры API
    const aiAnswer = chutesData.choices?.[0]?.message?.content || "Не удалось получить ответ от AI.";

    // 7. Возвращаем ответ на фронтенд
    return res.status(200).json({
        answer: aiAnswer,
        receivedQuestion: question,
        source: 'chutes-llm-api'
    });

} catch (chutesError) {
    console.error('Error calling Chutes LLM API:', {
        error: chutesError.message,
        stack: chutesError.stack,
        requestData: { // Безопасно логируем структуру запроса
            messagesCount: messages.length,
            lastMessage: messages[messages.length-1]?.content?.substring(0, 100)
        }
    });
    
    return res.status(200).json({
        answer: `Извините, возникла техническая ошибка при обработке сложного запроса. Пожалуйста, задайте ваш вопрос по-другому или свяжитесь с нами по телефону 8-800-250-25-56.`,
        error: true
    });
}
// ===== КОНЕЦ БЛОКА ДЛЯ ЗАМЕНЫ =====
            
        } catch (error) {
            console.error('Unexpected error in POST handler:', error);
            return res.status(500).json({ 
                error: 'Internal Server Error',
                details: error.message 
            });
        }
    }

    // 4. Все остальные методы (GET и т.д.)
    console.warn(`Method ${req.method} not allowed`);
    return res.status(405).json({ error: 'Method Not Allowed. Use POST or OPTIONS.' });
}
